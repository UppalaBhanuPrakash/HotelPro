<div class="container py-4">
  <!-- Header -->
  <div class="mb-4">
    <h1 class="fw-bold">Settings</h1>
    <p class="text-muted">Manage your account, security, and user preferences</p>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'profile'" (click)="activeTab = 'profile'"><i class="bi bi-person-fill"></i> Profile</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'security'" (click)="activeTab = 'security'"><i class="bi bi-lock-fill"></i> Change Password</a>
    </li>
    <li class="nav-item" *ngIf="canManageUsers()">
      <a class="nav-link" [class.active]="activeTab === 'users'" (click)="activeTab = 'users'"><i class="bi bi-people-fill"></i> User Management</a>
    </li>
    <li class="nav-item" *ngIf="currentUser?.role === 'admin'">
      <a class="nav-link" [class.active]="activeTab === 'permissions'" (click)="activeTab = 'permissions'"><i class="bi bi-key-fill"></i> Permissions</a>
    </li>
  </ul>

  <!-- PROFILE -->
  <div *ngIf="activeTab === 'profile'">
    <div class="card shadow-sm mb-4">
      <div class="card-header">
        <h5 class="mb-0">Profile Information</h5>
        <small class="text-muted">Update your personal information and preferences</small>
      </div>
      <div class="card-body">
        <form (ngSubmit)="updateProfile()" #profileForm="ngForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="name" class="form-label">Full Name</label>
              <input id="name" name="name" class="form-control"
                     type="text"
                     [(ngModel)]="profileData.name"
                     required minlength="2" pattern="^[a-zA-Z ]+$"
                     #nameRef="ngModel">
              <div *ngIf="nameRef.invalid && nameRef.touched" class="text-danger small mt-1">
                <div *ngIf="nameRef.errors?.['required']">Full Name is required.</div>
                <div *ngIf="nameRef.errors?.['minlength']">Full Name must be at least 2 characters.</div>
                <div *ngIf="nameRef.errors?.['pattern']">Special characters are not allowed.</div>
              </div>
            </div>

            <div class="col-md-6">
              <label for="email" class="form-label">Email Address</label>
              <input id="email" name="email" class="form-control" type="email"
                     [(ngModel)]="profileData.email" required email #emailRef="ngModel">
              <div *ngIf="emailRef.invalid && emailRef.touched" class="text-danger small mt-1">
                <div *ngIf="emailRef.errors?.['required']">Email is required.</div>
                <div *ngIf="emailRef.errors?.['email']">Enter a valid email address.</div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label for="phone" class="form-label">Phone Number</label>
              <input id="phone" name="phone" class="form-control" type="tel"
                     [(ngModel)]="profileData.phone"
                     pattern="^[0-9]{10}$" maxlength="10" #phoneRef="ngModel">
              <div *ngIf="phoneRef.invalid && phoneRef.touched" class="text-danger small mt-1">
                <div *ngIf="phoneRef.errors?.['pattern']">Phone number must be 10 digits only and no special character.</div>
              </div>
            </div>

            <div class="col-md-6">
              <label for="department" class="form-label">Department</label>
              <select id="department" name="department" class="form-select" [(ngModel)]="profileData.department">
                <option value="">Select Department</option>
                <option value="management">Management</option>
                <option value="front-desk">Front Desk</option>
                <option value="housekeeping">Housekeeping</option>
                <option value="maintenance">Maintenance</option>
                <option value="food-service">Food Service</option>
              </select>
            </div>
          </div>

          <div class="mt-3">
            <label for="bio" class="form-label">Bio</label>
            <textarea id="bio" name="bio" class="form-control" rows="4" [(ngModel)]="profileData.bio" placeholder="Tell us about yourself..."></textarea>
          </div>

          <div class="mt-4">
            <button type="submit" class="btn btn-primary" [disabled]="profileForm.invalid || profileLoading">
              <span *ngIf="profileLoading" class="spinner-border spinner-border-sm me-2"></span>
              {{ profileLoading ? 'Updating...' : 'Update Profile' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SECURITY -->
  <div *ngIf="activeTab === 'security'">
    <div class="card shadow-sm mb-4">
      <div class="card-header">
        <h5>Change Password</h5>
        <small class="text-muted">Keep your account secure with a strong password</small>
      </div>
      <div class="card-body">
        <form (ngSubmit)="changePassword()" #passwordForm="ngForm">
          <div class="mb-3">
            <label for="currentPassword" class="form-label">Current Password<span class="text-danger">*</span></label>
            <input id="currentPassword" name="currentPassword" class="form-control" type="password"
                   [(ngModel)]="passwordData.currentPassword" required minlength="6">
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="newPassword" class="form-label">New Password<span class="text-danger">*</span></label>
              <input id="newPassword" name="newPassword" class="form-control" type="password"
                     [(ngModel)]="passwordData.newPassword" required minlength="6">
            </div>
            <div class="col-md-6">
              <label for="confirmPassword" class="form-label">Confirm New Password<span class="text-danger">*</span></label>
              <input id="confirmPassword" name="confirmPassword" class="form-control" type="password"
                     [(ngModel)]="passwordData.confirmPassword" required minlength="6">
              <div class="text-danger small mt-1" *ngIf="passwordMismatch && passwordData.confirmPassword.length > 0">Passwords do not match</div>
            </div>
          </div>

          <div class="password-requirements mt-3">
            <h6>Password Requirements:</h6>
            <ul class="small">
              <li [class.text-success]="passwordData.newPassword.length >= 8">At least 8 characters</li>
              <li [class.text-success]="hasUppercase(passwordData.newPassword)">One uppercase letter</li>
              <li [class.text-success]="hasLowercase(passwordData.newPassword)">One lowercase letter</li>
              <li [class.text-success]="hasNumber(passwordData.newPassword)">One number</li>
              <li [class.text-success]="hasSpecialChar(passwordData.newPassword)">One special character</li>
            </ul>
          </div>

          <div class="mt-3">
            <div *ngIf="passwordChangeSuccess" class="alert alert-success">Password changed successfully!</div>
            <div *ngIf="passwordChangeError" class="alert alert-danger">{{ passwordChangeError }}</div>
            <button type="submit" class="btn btn-primary" [disabled]="passwordForm.invalid || passwordLoading || passwordMismatch">
              <span *ngIf="passwordLoading" class="spinner-border spinner-border-sm me-2"></span>
              {{ passwordLoading ? 'Changing...' : 'Change Password' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- USER MANAGEMENT -->
  <div *ngIf="activeTab === 'users'">
    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">User Management</h5>
          <small class="text-muted">Manage user accounts and permissions</small>
        </div>
        <div>
          <button class="btn btn-primary me-2" (click)="showRoleSelection = true"><i class="bi bi-plus icon-bold"></i>  New User</button>  
        </div>
      </div>

      <div class="card-body">
        <!-- Optional filters/search can be added here if you want -->
        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>User</th>
                <th>Role</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of filteredUsers">
                <td>
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center me-2" style="width:36px;height:36px;">
                      {{ getUserInitials(user.name || user.email) }}
                    </div>
                    <div>
                      <div>{{ user.name || user.email }}</div>
                      <div class="small text-muted">{{ user.email }}</div>
                    </div>
                  </div>
                </td>
                <td>{{ user.role | titlecase }}</td>
                <td>{{ user.status | titlecase }}</td>
                <td>{{ user.lastLogin | date:'short' }}</td>
                <td>
                  <button class="btn btn-sm btn-warning me-1" (click)="resetPassword(user)"><i class="bi bi-key-fill"></i> Reset Password</button>
                  <button class="btn btn-sm btn-danger" (click)="deleteUser(user.id)"><i class="bi bi-trash"></i></button>
                </td>
              </tr>
              <tr *ngIf="filteredUsers.length === 0">
                <td colspan="5" class="text-center text-muted">No users found</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Role Selection (Angular-driven modal) -->
    <div class="modal-backdrop d-flex justify-content-center align-items-center" *ngIf="showRoleSelection" style="position:fixed;inset:0;z-index:1050;background:rgba(0,0,0,0.4);">
      <div class="card p-3" style="max-width:420px;width:100%;">
        <div class="mb-3">
          <h5>Select User Role</h5>
        </div>
        <div class="d-grid gap-2">
          <button class="btn btn-primary" (click)="selectRole('admin')">Create Admin</button>
          <button class="btn btn-primary" (click)="selectRole('staff')">Create Staff</button>
          <button class="btn btn-secondary" (click)="showRoleSelection = false">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Create User Form Modal (Angular-driven) -->
    <div class="modal-backdrop d-flex justify-content-center align-items-center" *ngIf="showUserForm" style="position:fixed;inset:0;z-index:1050;background:rgba(0,0,0,0.4);">
      <div class="modal-dialog modal-dialog-centered" style="max-width:540px;">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create {{ selectedRole | titlecase }}</h5>
            <button type="button" class="btn-close" aria-label="Close" (click)="showUserForm=false"></button>
          </div>
          <div class="modal-body">
            <form (ngSubmit)="createUser()" #userForm="ngForm">
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input name="newUserEmail" class="form-control" type="email" [(ngModel)]="newUser.email" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Password</label>
                <input name="newUserPassword" class="form-control" type="password" [(ngModel)]="newUser.password" required minlength="6">
              </div>
              <div class="mb-3">
                <label class="form-label">Confirm Password</label>
                <input name="newUserConfirm" class="form-control" type="password" [(ngModel)]="newUser.confirmPassword" required minlength="6">
                <div *ngIf="newUser.password !== newUser.confirmPassword " class="text-danger small mt-1">Passwords do not match</div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary cancel" (click)="showUserForm=false">Cancel</button>
            <button class="btn btn-primary" [disabled]="!newUser.email || !newUser.password || newUser.password !== newUser.confirmPassword" (click)="createUser()">Create User</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PERMISSIONS -->
  <div *ngIf="activeTab === 'permissions' && currentUser?.role === 'admin'">
    <div class="card shadow-sm mb-4">
      <div class="card-header"><h5>Role Permissions</h5></div>
      <div class="card-body">
        <div *ngFor="let role of roles" class="mb-4">
          <h6>{{ role.name }} Permissions</h6>
          <div class="row">
            <div class="col-md-4 mb-2" *ngFor="let permission of availablePermissions">
              <div class="form-check">
                <input class="form-check-input" type="checkbox"
                       [checked]="role.permissions.includes(permission.key)"
                       (change)="toggleRolePermission(role.key, permission.key)">
                <label class="form-check-label">{{ permission.name }}</label>
                <div class="small text-muted">{{ permission.description }}</div>
              </div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" (click)="savePermissions()">Save Permission Changes</button>
      </div>
    </div>
  </div>
</div>
